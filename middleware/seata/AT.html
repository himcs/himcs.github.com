<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.60">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>AT 模式 | mcs site</title><meta name="description" content="mcs site">
    <link rel="preload" href="/assets/style-d36873cb.css" as="style"><link rel="stylesheet" href="/assets/style-d36873cb.css">
    <link rel="modulepreload" href="/assets/app-02526c39.js"><link rel="modulepreload" href="/assets/framework-fa6fd9c7.js"><link rel="modulepreload" href="/assets/AT.html-9b666f6a.js"><link rel="modulepreload" href="/assets/AT.html-ea2a2786.js"><link rel="prefetch" href="/assets/index.html-e3637351.js" as="script"><link rel="prefetch" href="/assets/BFS.html-5ee798f8.js" as="script"><link rel="prefetch" href="/assets/index.html-b93b8b77.js" as="script"><link rel="prefetch" href="/assets/treeInRDBMS.html-b2b46b19.js" as="script"><link rel="prefetch" href="/assets/二分算法.html-c8df13fd.js" as="script"><link rel="prefetch" href="/assets/排序算法.html-18a21f06.js" as="script"><link rel="prefetch" href="/assets/index.html-44b467fe.js" as="script"><link rel="prefetch" href="/assets/index.html-d6a6781a.js" as="script"><link rel="prefetch" href="/assets/限流算法.html-5d142028.js" as="script"><link rel="prefetch" href="/assets/index.html-55c950d8.js" as="script"><link rel="prefetch" href="/assets/index.html-a32de3d5.js" as="script"><link rel="prefetch" href="/assets/贷款利息公式.html-9dbeddb4.js" as="script"><link rel="prefetch" href="/assets/index.html-36798202.js" as="script"><link rel="prefetch" href="/assets/12factor.html-479c9438.js" as="script"><link rel="prefetch" href="/assets/index.html-d6f2d380.js" as="script"><link rel="prefetch" href="/assets/index.html-7fa4712d.js" as="script"><link rel="prefetch" href="/assets/index.html-72ac39b0.js" as="script"><link rel="prefetch" href="/assets/codegen.html-abfab9e5.js" as="script"><link rel="prefetch" href="/assets/excel_string.html-935fe534.js" as="script"><link rel="prefetch" href="/assets/index.html-0fb3ce0a.js" as="script"><link rel="prefetch" href="/assets/maven配置.html-3e6edaf7.js" as="script"><link rel="prefetch" href="/assets/pdf_better.html-57bb6dee.js" as="script"><link rel="prefetch" href="/assets/pdf_page.html-af326694.js" as="script"><link rel="prefetch" href="/assets/pic_go.html-c25e020c.js" as="script"><link rel="prefetch" href="/assets/soft.html-e9adc608.js" as="script"><link rel="prefetch" href="/assets/util_web.html-1dcdb62e.js" as="script"><link rel="prefetch" href="/assets/MySQL参数配置.html-6266d173.js" as="script"><link rel="prefetch" href="/assets/mysql_group_contact.html-0d64789d.js" as="script"><link rel="prefetch" href="/assets/密码修改.html-84b8ee4d.js" as="script"><link rel="prefetch" href="/assets/事务.html-b84d52f2.js" as="script"><link rel="prefetch" href="/assets/es_base.html-51d680c5.js" as="script"><link rel="prefetch" href="/assets/es_search.html-b277d662.js" as="script"><link rel="prefetch" href="/assets/aggregate.html-5edc4211.js" as="script"><link rel="prefetch" href="/assets/base.html-3e24dec1.js" as="script"><link rel="prefetch" href="/assets/数据库范式.html-ece9fdd9.js" as="script"><link rel="prefetch" href="/assets/BigDecimal.html-a726fc42.js" as="script"><link rel="prefetch" href="/assets/0basic.html-e114fc05.js" as="script"><link rel="prefetch" href="/assets/1ObjectsAndClasses.html-244abc3a.js" as="script"><link rel="prefetch" href="/assets/2Extends.html-3c7595e9.js" as="script"><link rel="prefetch" href="/assets/3Interface.html-91928fde.js" as="script"><link rel="prefetch" href="/assets/Collection.html-7e31158e.js" as="script"><link rel="prefetch" href="/assets/IO.html-7883374d.js" as="script"><link rel="prefetch" href="/assets/NIO.html-165e80b1.js" as="script"><link rel="prefetch" href="/assets/Stream.html-49b7afe6.js" as="script"><link rel="prefetch" href="/assets/generic.html-0c3a1060.js" as="script"><link rel="prefetch" href="/assets/index.html-53823c0b.js" as="script"><link rel="prefetch" href="/assets/正则表达式.html-3824543e.js" as="script"><link rel="prefetch" href="/assets/index.html-dae21037.js" as="script"><link rel="prefetch" href="/assets/AQS.html-1fa75d6e.js" as="script"><link rel="prefetch" href="/assets/JVM内存模型.html-f3a84bf2.js" as="script"><link rel="prefetch" href="/assets/ServiceLoader.html-c3f4cb27.js" as="script"><link rel="prefetch" href="/assets/index.html-8adf4226.js" as="script"><link rel="prefetch" href="/assets/Jar_Manifest_File.html-9f6d982b.js" as="script"><link rel="prefetch" href="/assets/项目自动化.html-b02671c6.js" as="script"><link rel="prefetch" href="/assets/Spring集成测试.html-cea17b5c.js" as="script"><link rel="prefetch" href="/assets/todo_api.html-30a717d8.js" as="script"><link rel="prefetch" href="/assets/todo_cli.html-24da0206.js" as="script"><link rel="prefetch" href="/assets/todo_core.html-d7fa5216.js" as="script"><link rel="prefetch" href="/assets/什么是好的自动化测试.html-625021f6.js" as="script"><link rel="prefetch" href="/assets/如何让测试可控.html-9bd68e1a.js" as="script"><link rel="prefetch" href="/assets/AQS.html-bef6daa9.js" as="script"><link rel="prefetch" href="/assets/BlockingQueue.html-e4caeea2.js" as="script"><link rel="prefetch" href="/assets/Java多线程基础类和接口.html-cce41823.js" as="script"><link rel="prefetch" href="/assets/Java线程状态.html-d35c6bcb.js" as="script"><link rel="prefetch" href="/assets/Java线程通信.html-73a83f83.js" as="script"><link rel="prefetch" href="/assets/Lock接口.html-670d27d5.js" as="script"><link rel="prefetch" href="/assets/cas.html-c8e3a4d1.js" as="script"><link rel="prefetch" href="/assets/synchronized.html-d6115ee8.js" as="script"><link rel="prefetch" href="/assets/volatile.html-d877712a.js" as="script"><link rel="prefetch" href="/assets/内存模型.html-40c19b4b.js" as="script"><link rel="prefetch" href="/assets/线程池.html-4c4a7e17.js" as="script"><link rel="prefetch" href="/assets/线程组和优先级.html-b60a47d4.js" as="script"><link rel="prefetch" href="/assets/重排序.html-b02e11fe.js" as="script"><link rel="prefetch" href="/assets/cron.html-e6d81514.js" as="script"><link rel="prefetch" href="/assets/index.html-503c299a.js" as="script"><link rel="prefetch" href="/assets/lombok.html-6255110e.js" as="script"><link rel="prefetch" href="/assets/mockito.html-d73411a8.js" as="script"><link rel="prefetch" href="/assets/proto-idea.html-5874f2e3.js" as="script"><link rel="prefetch" href="/assets/rabbitmq_start.html-ac480885.js" as="script"><link rel="prefetch" href="/assets/redis.html-de21c0e3.js" as="script"><link rel="prefetch" href="/assets/redis_lock.html-ca6d4e37.js" as="script"><link rel="prefetch" href="/assets/redis_shared.html-fda6e554.js" as="script"><link rel="prefetch" href="/assets/CAP_basic.html-f19a83be.js" as="script"><link rel="prefetch" href="/assets/TCC.html-94921cc0.js" as="script"><link rel="prefetch" href="/assets/MI8SE.html-b5328645.js" as="script"><link rel="prefetch" href="/assets/docker-expose.html-5082f704.js" as="script"><link rel="prefetch" href="/assets/docker_core.html-412ece21.js" as="script"><link rel="prefetch" href="/assets/jar_develop.html-8579df3c.js" as="script"><link rel="prefetch" href="/assets/linux_config.html-33df38ea.js" as="script"><link rel="prefetch" href="/assets/git_ssh.html-99eadbb9.js" as="script"><link rel="prefetch" href="/assets/travis-with-hexo.html-65a3d5f0.js" as="script"><link rel="prefetch" href="/assets/IDEA_plugin_dev.html-8c3709ae.js" as="script"><link rel="prefetch" href="/assets/awk.html-c7d57f15.js" as="script"><link rel="prefetch" href="/assets/centos_static_IP_config.html-0d27a5d3.js" as="script"><link rel="prefetch" href="/assets/nginx.html-a4ca41a0.js" as="script"><link rel="prefetch" href="/assets/server-move.html-b0670287.js" as="script"><link rel="prefetch" href="/assets/ssh-D.html-4fdcc6c6.js" as="script"><link rel="prefetch" href="/assets/ssr-create.html-8ef39818.js" as="script"><link rel="prefetch" href="/assets/PHP.html-3cf89290.js" as="script"><link rel="prefetch" href="/assets/curlproxy.html-c3a14c51.js" as="script"><link rel="prefetch" href="/assets/ext.html-4de68fd7.js" as="script"><link rel="prefetch" href="/assets/lock.html-28c2dd8a.js" as="script"><link rel="prefetch" href="/assets/nginxconf.html-fbe8ed13.js" as="script"><link rel="prefetch" href="/assets/php_ob.html-2ad368bb.js" as="script"><link rel="prefetch" href="/assets/srv.html-0ea4bbca.js" as="script"><link rel="prefetch" href="/assets/scrapy-env.html-66ff8592.js" as="script"><link rel="prefetch" href="/assets/scrapy_develop.html-5142715c.js" as="script"><link rel="prefetch" href="/assets/scrapy_env.html-902aed7b.js" as="script"><link rel="prefetch" href="/assets/svn-cantup.html-061bfbb0.js" as="script"><link rel="prefetch" href="/assets/svn_auto_update.html-cd3ccf12.js" as="script"><link rel="prefetch" href="/assets/arch.html-f902c8b5.js" as="script"><link rel="prefetch" href="/assets/routing.html-6b299493.js" as="script"><link rel="prefetch" href="/assets/JWT.html-f4039123.js" as="script"><link rel="prefetch" href="/assets/OAuth2.html-903f628a.js" as="script"><link rel="prefetch" href="/assets/SpringBoot-Github.html-59fc45f8.js" as="script"><link rel="prefetch" href="/assets/tcp.html-560a7178.js" as="script"><link rel="prefetch" href="/assets/activiti.html-d71efd9d.js" as="script"><link rel="prefetch" href="/assets/一把梭.html-10e1ccfe.js" as="script"><link rel="prefetch" href="/assets/网关.html-dcd4a9b1.js" as="script"><link rel="prefetch" href="/assets/1_Eureka_register.html-b07da420.js" as="script"><link rel="prefetch" href="/assets/2_Eureka_register.html-4c6debea.js" as="script"><link rel="prefetch" href="/assets/3_Eureka_call.html-626eb68c.js" as="script"><link rel="prefetch" href="/assets/4_Eureka_config_basic.html-7591a700.js" as="script"><link rel="prefetch" href="/assets/4_Eureka_config_basic2.html-feedb7f4.js" as="script"><link rel="prefetch" href="/assets/5_Eureka_Zuul.html-f111e9ea.js" as="script"><link rel="prefetch" href="/assets/6_Eureka_Sleuth_Zipkin.html-f3407eb6.js" as="script"><link rel="prefetch" href="/assets/index.html-b7141cd3.js" as="script"><link rel="prefetch" href="/assets/CAP定理.html-c771abde.js" as="script"><link rel="prefetch" href="/assets/Seata.html-56d00a79.js" as="script"><link rel="prefetch" href="/assets/idea_jsp.html-7ef6297a.js" as="script"><link rel="prefetch" href="/assets/office_act.html-8a66cf24.js" as="script"><link rel="prefetch" href="/assets/B_.html-90eb6756.js" as="script"><link rel="prefetch" href="/assets/索引分类.html-5532e68b.js" as="script"><link rel="prefetch" href="/assets/index.html-5d54cb41.js" as="script"><link rel="prefetch" href="/assets/mbg.html-32085233.js" as="script"><link rel="prefetch" href="/assets/Spring Cloud Gateway.html-d7f21a0b.js" as="script"><link rel="prefetch" href="/assets/nacos deploy.html-edded1db.js" as="script"><link rel="prefetch" href="/assets/创建nacos服务.html-1a7558b9.js" as="script"><link rel="prefetch" href="/assets/OpenFeign.html-a24132b2.js" as="script"><link rel="prefetch" href="/assets/ribbon负载均衡.html-3055b63f.js" as="script"><link rel="prefetch" href="/assets/Sentinel.html-1ce0d153.js" as="script"><link rel="prefetch" href="/assets/Sentinel与Nacos配置持久化.html-44b21a2a.js" as="script"><link rel="prefetch" href="/assets/Sentinel熔断机制.html-24c98ca4.js" as="script"><link rel="prefetch" href="/assets/Sentine流量控制.html-564c80d6.js" as="script"><link rel="prefetch" href="/assets/整合openfeign.html-a3964a2e.js" as="script"><link rel="prefetch" href="/assets/会话一致性解决方案.html-a733f2e1.js" as="script"><link rel="prefetch" href="/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/assets/index.html-e6f8a7c5.js" as="script"><link rel="prefetch" href="/assets/BFS.html-5fb14798.js" as="script"><link rel="prefetch" href="/assets/index.html-b54f06be.js" as="script"><link rel="prefetch" href="/assets/treeInRDBMS.html-6760905c.js" as="script"><link rel="prefetch" href="/assets/二分算法.html-0cbd6296.js" as="script"><link rel="prefetch" href="/assets/排序算法.html-a7730e87.js" as="script"><link rel="prefetch" href="/assets/index.html-d61d59d3.js" as="script"><link rel="prefetch" href="/assets/index.html-19dc7e77.js" as="script"><link rel="prefetch" href="/assets/限流算法.html-2796e57b.js" as="script"><link rel="prefetch" href="/assets/index.html-def37add.js" as="script"><link rel="prefetch" href="/assets/index.html-24ad8b59.js" as="script"><link rel="prefetch" href="/assets/贷款利息公式.html-a4c6ad86.js" as="script"><link rel="prefetch" href="/assets/index.html-b3153526.js" as="script"><link rel="prefetch" href="/assets/12factor.html-fe9f668c.js" as="script"><link rel="prefetch" href="/assets/index.html-02a80aeb.js" as="script"><link rel="prefetch" href="/assets/index.html-12ad56a6.js" as="script"><link rel="prefetch" href="/assets/index.html-1936f5cd.js" as="script"><link rel="prefetch" href="/assets/codegen.html-668ef229.js" as="script"><link rel="prefetch" href="/assets/excel_string.html-6d59f44f.js" as="script"><link rel="prefetch" href="/assets/index.html-f457a55e.js" as="script"><link rel="prefetch" href="/assets/maven配置.html-7af68477.js" as="script"><link rel="prefetch" href="/assets/pdf_better.html-4b67b1fd.js" as="script"><link rel="prefetch" href="/assets/pdf_page.html-71dd14c7.js" as="script"><link rel="prefetch" href="/assets/pic_go.html-03f0fe81.js" as="script"><link rel="prefetch" href="/assets/soft.html-2baea67a.js" as="script"><link rel="prefetch" href="/assets/util_web.html-043e8e7e.js" as="script"><link rel="prefetch" href="/assets/MySQL参数配置.html-fdbdcc9f.js" as="script"><link rel="prefetch" href="/assets/mysql_group_contact.html-52815ae3.js" as="script"><link rel="prefetch" href="/assets/密码修改.html-40b974b5.js" as="script"><link rel="prefetch" href="/assets/事务.html-def9165d.js" as="script"><link rel="prefetch" href="/assets/es_base.html-294cb6cd.js" as="script"><link rel="prefetch" href="/assets/es_search.html-13233a0c.js" as="script"><link rel="prefetch" href="/assets/aggregate.html-4c7705e0.js" as="script"><link rel="prefetch" href="/assets/base.html-cc59d641.js" as="script"><link rel="prefetch" href="/assets/数据库范式.html-a4394ceb.js" as="script"><link rel="prefetch" href="/assets/BigDecimal.html-847102ad.js" as="script"><link rel="prefetch" href="/assets/0basic.html-02259f9c.js" as="script"><link rel="prefetch" href="/assets/1ObjectsAndClasses.html-d2e4af1b.js" as="script"><link rel="prefetch" href="/assets/2Extends.html-02388a15.js" as="script"><link rel="prefetch" href="/assets/3Interface.html-fa289196.js" as="script"><link rel="prefetch" href="/assets/Collection.html-3b94d71b.js" as="script"><link rel="prefetch" href="/assets/IO.html-c6e1c346.js" as="script"><link rel="prefetch" href="/assets/NIO.html-d7cd796e.js" as="script"><link rel="prefetch" href="/assets/Stream.html-436caa95.js" as="script"><link rel="prefetch" href="/assets/generic.html-ebb05c32.js" as="script"><link rel="prefetch" href="/assets/index.html-f2aa8179.js" as="script"><link rel="prefetch" href="/assets/正则表达式.html-d52734ce.js" as="script"><link rel="prefetch" href="/assets/index.html-700e307f.js" as="script"><link rel="prefetch" href="/assets/AQS.html-781c241f.js" as="script"><link rel="prefetch" href="/assets/JVM内存模型.html-0a056841.js" as="script"><link rel="prefetch" href="/assets/ServiceLoader.html-59947863.js" as="script"><link rel="prefetch" href="/assets/index.html-e95ca13d.js" as="script"><link rel="prefetch" href="/assets/Jar_Manifest_File.html-6530dcd4.js" as="script"><link rel="prefetch" href="/assets/项目自动化.html-aa5ec372.js" as="script"><link rel="prefetch" href="/assets/Spring集成测试.html-2316d15b.js" as="script"><link rel="prefetch" href="/assets/todo_api.html-db1e7e85.js" as="script"><link rel="prefetch" href="/assets/todo_cli.html-02eecfb2.js" as="script"><link rel="prefetch" href="/assets/todo_core.html-86b653a7.js" as="script"><link rel="prefetch" href="/assets/什么是好的自动化测试.html-02b0c16d.js" as="script"><link rel="prefetch" href="/assets/如何让测试可控.html-f6754cac.js" as="script"><link rel="prefetch" href="/assets/AQS.html-8bc07cf0.js" as="script"><link rel="prefetch" href="/assets/BlockingQueue.html-8eacee2a.js" as="script"><link rel="prefetch" href="/assets/Java多线程基础类和接口.html-8a4b5dcb.js" as="script"><link rel="prefetch" href="/assets/Java线程状态.html-04c6bb5f.js" as="script"><link rel="prefetch" href="/assets/Java线程通信.html-ee849129.js" as="script"><link rel="prefetch" href="/assets/Lock接口.html-8edf2b85.js" as="script"><link rel="prefetch" href="/assets/cas.html-074f2187.js" as="script"><link rel="prefetch" href="/assets/synchronized.html-80e5e10e.js" as="script"><link rel="prefetch" href="/assets/volatile.html-cd0a377d.js" as="script"><link rel="prefetch" href="/assets/内存模型.html-0bf6b3c2.js" as="script"><link rel="prefetch" href="/assets/线程池.html-e4ba347e.js" as="script"><link rel="prefetch" href="/assets/线程组和优先级.html-07ff6b17.js" as="script"><link rel="prefetch" href="/assets/重排序.html-1df412d2.js" as="script"><link rel="prefetch" href="/assets/cron.html-89cef6ef.js" as="script"><link rel="prefetch" href="/assets/index.html-72df99e1.js" as="script"><link rel="prefetch" href="/assets/lombok.html-2ab71d80.js" as="script"><link rel="prefetch" href="/assets/mockito.html-5e63e9a6.js" as="script"><link rel="prefetch" href="/assets/proto-idea.html-5f8350a7.js" as="script"><link rel="prefetch" href="/assets/rabbitmq_start.html-8d9d7efe.js" as="script"><link rel="prefetch" href="/assets/redis.html-c6346aab.js" as="script"><link rel="prefetch" href="/assets/redis_lock.html-704fb123.js" as="script"><link rel="prefetch" href="/assets/redis_shared.html-329e114a.js" as="script"><link rel="prefetch" href="/assets/CAP_basic.html-3f0d34f7.js" as="script"><link rel="prefetch" href="/assets/TCC.html-e7ae49db.js" as="script"><link rel="prefetch" href="/assets/MI8SE.html-851d720a.js" as="script"><link rel="prefetch" href="/assets/docker-expose.html-a9532fdc.js" as="script"><link rel="prefetch" href="/assets/docker_core.html-f94a8ba5.js" as="script"><link rel="prefetch" href="/assets/jar_develop.html-cab1dd4a.js" as="script"><link rel="prefetch" href="/assets/linux_config.html-9154d9e1.js" as="script"><link rel="prefetch" href="/assets/git_ssh.html-3df5f353.js" as="script"><link rel="prefetch" href="/assets/travis-with-hexo.html-9cdc54a7.js" as="script"><link rel="prefetch" href="/assets/IDEA_plugin_dev.html-7b31c2ad.js" as="script"><link rel="prefetch" href="/assets/awk.html-0ca75610.js" as="script"><link rel="prefetch" href="/assets/centos_static_IP_config.html-46b38a0d.js" as="script"><link rel="prefetch" href="/assets/nginx.html-5983a503.js" as="script"><link rel="prefetch" href="/assets/server-move.html-93ca44f8.js" as="script"><link rel="prefetch" href="/assets/ssh-D.html-a52211e6.js" as="script"><link rel="prefetch" href="/assets/ssr-create.html-e7ee6604.js" as="script"><link rel="prefetch" href="/assets/PHP.html-f556dadb.js" as="script"><link rel="prefetch" href="/assets/curlproxy.html-c7c1967d.js" as="script"><link rel="prefetch" href="/assets/ext.html-74acd3da.js" as="script"><link rel="prefetch" href="/assets/lock.html-ebfb3abb.js" as="script"><link rel="prefetch" href="/assets/nginxconf.html-edc332f1.js" as="script"><link rel="prefetch" href="/assets/php_ob.html-1882ff45.js" as="script"><link rel="prefetch" href="/assets/srv.html-3249fd1b.js" as="script"><link rel="prefetch" href="/assets/scrapy-env.html-44d856dc.js" as="script"><link rel="prefetch" href="/assets/scrapy_develop.html-355280bc.js" as="script"><link rel="prefetch" href="/assets/scrapy_env.html-b0a15e9c.js" as="script"><link rel="prefetch" href="/assets/svn-cantup.html-f6015702.js" as="script"><link rel="prefetch" href="/assets/svn_auto_update.html-120baa32.js" as="script"><link rel="prefetch" href="/assets/arch.html-d37bceef.js" as="script"><link rel="prefetch" href="/assets/routing.html-5c87e9b8.js" as="script"><link rel="prefetch" href="/assets/JWT.html-a3ae250b.js" as="script"><link rel="prefetch" href="/assets/OAuth2.html-1bd45457.js" as="script"><link rel="prefetch" href="/assets/SpringBoot-Github.html-992b560f.js" as="script"><link rel="prefetch" href="/assets/tcp.html-0706a3f0.js" as="script"><link rel="prefetch" href="/assets/activiti.html-13c8ca61.js" as="script"><link rel="prefetch" href="/assets/一把梭.html-f72f929b.js" as="script"><link rel="prefetch" href="/assets/网关.html-a2161940.js" as="script"><link rel="prefetch" href="/assets/1_Eureka_register.html-f8c331a0.js" as="script"><link rel="prefetch" href="/assets/2_Eureka_register.html-c7a6fac0.js" as="script"><link rel="prefetch" href="/assets/3_Eureka_call.html-ef9eba75.js" as="script"><link rel="prefetch" href="/assets/4_Eureka_config_basic.html-10da1b2b.js" as="script"><link rel="prefetch" href="/assets/4_Eureka_config_basic2.html-8af8b430.js" as="script"><link rel="prefetch" href="/assets/5_Eureka_Zuul.html-d7fdd11d.js" as="script"><link rel="prefetch" href="/assets/6_Eureka_Sleuth_Zipkin.html-06c7bbfd.js" as="script"><link rel="prefetch" href="/assets/index.html-4988c18b.js" as="script"><link rel="prefetch" href="/assets/CAP定理.html-a3e291fd.js" as="script"><link rel="prefetch" href="/assets/Seata.html-a11867d5.js" as="script"><link rel="prefetch" href="/assets/idea_jsp.html-e1c81b49.js" as="script"><link rel="prefetch" href="/assets/office_act.html-a3c6a531.js" as="script"><link rel="prefetch" href="/assets/B_.html-8e022b10.js" as="script"><link rel="prefetch" href="/assets/索引分类.html-1ebd5e92.js" as="script"><link rel="prefetch" href="/assets/index.html-1acbdbf1.js" as="script"><link rel="prefetch" href="/assets/mbg.html-a40aadf3.js" as="script"><link rel="prefetch" href="/assets/Spring Cloud Gateway.html-9f34da7a.js" as="script"><link rel="prefetch" href="/assets/nacos deploy.html-cee59b7d.js" as="script"><link rel="prefetch" href="/assets/创建nacos服务.html-ed0a97c0.js" as="script"><link rel="prefetch" href="/assets/OpenFeign.html-eec9668e.js" as="script"><link rel="prefetch" href="/assets/ribbon负载均衡.html-50b5b10e.js" as="script"><link rel="prefetch" href="/assets/Sentinel.html-d2503809.js" as="script"><link rel="prefetch" href="/assets/Sentinel与Nacos配置持久化.html-b474951f.js" as="script"><link rel="prefetch" href="/assets/Sentinel熔断机制.html-987ad85d.js" as="script"><link rel="prefetch" href="/assets/Sentine流量控制.html-64beff1b.js" as="script"><link rel="prefetch" href="/assets/整合openfeign.html-93d9360b.js" as="script"><link rel="prefetch" href="/assets/会话一致性解决方案.html-298009db.js" as="script"><link rel="prefetch" href="/assets/404.html-065e9e30.js" as="script"><link rel="prefetch" href="/assets/index-70769223.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="https://vuejs.org/images/logo.png" alt="mcs site"><span class="site-name can-hide">mcs site</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/java/" class="" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/spring/cloud/" class="" aria-label="Spring Cloud"><!--[--><!--]--> Spring Cloud <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/java/framework/" class="" aria-label="框架"><!--[--><!--]--> 框架 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/ha" class="" aria-label="高可用"><!--[--><!--]--> 高可用 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Data"><span class="title">Data</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Data"><span class="title">Data</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/database/" class="" aria-label="数据库"><!--[--><!--]--> 数据库 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/middleware/" class="router-link-active" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/alg/" class="" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/rfc/" class="" aria-label="RFC"><!--[--><!--]--> RFC <!--[--><!--]--></a></div><div class="navbar-item"><a href="/util/" class="" aria-label="工具"><!--[--><!--]--> 工具 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/java/" class="" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/spring/cloud/" class="" aria-label="Spring Cloud"><!--[--><!--]--> Spring Cloud <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/java/framework/" class="" aria-label="框架"><!--[--><!--]--> 框架 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/ha" class="" aria-label="高可用"><!--[--><!--]--> 高可用 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Data"><span class="title">Data</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Data"><span class="title">Data</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/database/" class="" aria-label="数据库"><!--[--><!--]--> 数据库 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/middleware/" class="router-link-active" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/alg/" class="" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/rfc/" class="" aria-label="RFC"><!--[--><!--]--> RFC <!--[--><!--]--></a></div><div class="navbar-item"><a href="/util/" class="" aria-label="工具"><!--[--><!--]--> 工具 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">Redis <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/middleware/redis/redis.html" class="sidebar-item" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a><!----></li><li><a href="/middleware/redis/redis_lock.html" class="sidebar-item" aria-label="Redis分布式锁"><!--[--><!--]--> Redis分布式锁 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">rabbitmq <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/middleware/rabbitmq/rabbitmq_start.html" class="sidebar-item" aria-label="RabbitMQ Start"><!--[--><!--]--> RabbitMQ Start <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active collapsible">Seata <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/middleware/seata/CAP_basic.html" class="sidebar-item" aria-label="CAP定理"><!--[--><!--]--> CAP定理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="AT 模式"><!--[--><!--]--> AT 模式 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/middleware/seata/AT.html#要求" class="router-link-active router-link-exact-active sidebar-item" aria-label="要求"><!--[--><!--]--> 要求 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#机制" class="router-link-active router-link-exact-active sidebar-item" aria-label="机制"><!--[--><!--]--> 机制 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#写隔离" class="router-link-active router-link-exact-active sidebar-item" aria-label="写隔离"><!--[--><!--]--> 写隔离 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/middleware/seata/AT.html#成功案例" class="router-link-active router-link-exact-active sidebar-item" aria-label="成功案例"><!--[--><!--]--> 成功案例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#回滚案例" class="router-link-active router-link-exact-active sidebar-item" aria-label="回滚案例"><!--[--><!--]--> 回滚案例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/middleware/seata/AT.html#读隔离" class="router-link-active router-link-exact-active sidebar-item" aria-label="读隔离"><!--[--><!--]--> 读隔离 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#工作机制" class="router-link-active router-link-exact-active sidebar-item" aria-label="工作机制"><!--[--><!--]--> 工作机制 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/middleware/seata/AT.html#一阶段" class="router-link-active router-link-exact-active sidebar-item" aria-label="一阶段"><!--[--><!--]--> 一阶段 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#二阶段" class="router-link-active router-link-exact-active sidebar-item" aria-label="二阶段"><!--[--><!--]--> 二阶段 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/middleware/seata/AT.html#coding" class="router-link-active router-link-exact-active sidebar-item" aria-label="Coding"><!--[--><!--]--> Coding <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/middleware/seata/AT.html#建表" class="router-link-active router-link-exact-active sidebar-item" aria-label="建表"><!--[--><!--]--> 建表 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#依赖" class="router-link-active router-link-exact-active sidebar-item" aria-label="依赖"><!--[--><!--]--> 依赖 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#添加文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="添加文件"><!--[--><!--]--> 添加文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置"><!--[--><!--]--> 配置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#tm-端" class="router-link-active router-link-exact-active sidebar-item" aria-label="TM 端"><!--[--><!--]--> TM 端 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/middleware/seata/AT.html#rm-端" class="router-link-active router-link-exact-active sidebar-item" aria-label="RM 端"><!--[--><!--]--> RM 端 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="at-模式" tabindex="-1"><a class="header-anchor" href="#at-模式" aria-hidden="true">#</a> AT 模式</h1><h2 id="要求" tabindex="-1"><a class="header-anchor" href="#要求" aria-hidden="true">#</a> 要求</h2><ul><li>基于ACID关系数据库</li><li>Java应用，基于JDBC</li></ul><h2 id="机制" tabindex="-1"><a class="header-anchor" href="#机制" aria-hidden="true">#</a> 机制</h2><p>两阶段提交</p><ul><li>一阶段： 业务数据和回滚日志记录在一个本地事务提交，释放本地锁和连接资源</li><li>二阶段： <ul><li>成功： 提交异步化，快速完成</li><li>失败： 通过一阶段回滚日志进行反向补偿</li></ul></li></ul><h2 id="写隔离" tabindex="-1"><a class="header-anchor" href="#写隔离" aria-hidden="true">#</a> 写隔离</h2><ul><li>一阶段本地事务提交前，确保拿到全局锁</li><li>拿不到全局锁，不能提交本地事务</li><li>拿全局锁尝试限制一定范围内，超出范围将放弃，并释放本地锁</li></ul><h3 id="成功案例" tabindex="-1"><a class="header-anchor" href="#成功案例" aria-hidden="true">#</a> 成功案例</h3><blockquote><p>tx1 先开始，开启本地事务，拿到本地锁，更新操作 m = 1000 - 100 = 900。本地事务提交前，先拿到该记录的 <strong>全局锁</strong> ，本地提交释放本地锁。 tx2 后开始，开启本地事务，拿到本地锁，更新操作 m = 900 - 100 = 800。本地事务提交前，尝试拿该记录的 <strong>全局锁</strong> ，tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待 <strong>全局锁</strong> 。</p><p>tx1 二阶段全局提交，释放 <strong>全局锁</strong> 。tx2 拿到 <strong>全局锁</strong> 提交本地事务。</p></blockquote><p><img src="/assets/XA-8c6d68f2.svg" alt="XA"></p><h3 id="回滚案例" tabindex="-1"><a class="header-anchor" href="#回滚案例" aria-hidden="true">#</a> 回滚案例</h3><blockquote><p>如果 tx1 的二阶段全局回滚，则 tx1 需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支的回滚。</p><p>此时，如果 tx2 仍在等待该数据的 <strong>全局锁</strong>，同时持有本地锁，则 tx1 的分支回滚会失败。分支的回滚会一直重试，直到 tx2 的 <strong>全局锁</strong> 等锁超时，放弃 <strong>全局锁</strong> 并回滚本地事务释放本地锁，tx1 的分支回滚最终成功。</p><p>因为整个过程 <strong>全局锁</strong> 在 tx1 结束前一直是被 tx1 持有的，所以不会发生 <strong>脏写</strong> 的问题。</p></blockquote><p><img src="/assets/XA-rollback-5ceb2be6.svg" alt="XA-rollback"></p><h2 id="读隔离" tabindex="-1"><a class="header-anchor" href="#读隔离" aria-hidden="true">#</a> 读隔离</h2><p>AT模式默认全局级别是读未提交(Read Uncommitted)</p><p>特点场景下，必须要求全局的 读已提交 ， 目前通过 <code>SELECT FOR UPDATE</code> 语句代理。</p><p><img src="https://img.alicdn.com/tfs/TB138wuwYj1gK0jSZFuXXcrHpXa-724-521.png" alt="Read Isolation: SELECT FOR UPDATE"></p><blockquote><p>SELECT FOR UPDATE 语句的执行会申请 <strong>全局锁</strong> ，如果 <strong>全局锁</strong> 被其他事务持有，则释放本地锁（回滚 SELECT FOR UPDATE 语句的本地执行）并重试。这个过程中，查询是被 block 住的，直到 <strong>全局锁</strong> 拿到，即读取的相关数据是 <strong>已提交</strong> 的，才返回。</p><p>出于总体性能上的考虑，Seata 目前的方案并没有对所有 SELECT 语句都进行代理，仅针对 FOR UPDATE 的 SELECT 语句。</p></blockquote><h2 id="工作机制" tabindex="-1"><a class="header-anchor" href="#工作机制" aria-hidden="true">#</a> 工作机制</h2><p>TC TM 向 TC 注册</p><p>TC 发起 全局事务 ,</p><p>通知RM 执行，RM会执行并向TC汇报结果</p><p>TC根据结果 全局提交或回滚</p><h3 id="一阶段" tabindex="-1"><a class="header-anchor" href="#一阶段" aria-hidden="true">#</a> 一阶段</h3><ol><li><p>解析SQL，获得SQL类型条件</p></li><li><p>查询前镜像：根据解析得到的条件信息，生成查询语句，定位数据</p></li><li><p>执行业务SQL</p></li><li><p>查询后镜像</p></li><li><p>插入回滚日志，将前后镜像及业务SQL组成一条回滚日志，插入<code>UNDO_LOG</code>表</p></li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;branchId&quot;</span><span class="token operator">:</span> <span class="token number">641789253</span><span class="token punctuation">,</span>
	<span class="token property">&quot;undoItems&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
		<span class="token property">&quot;afterImage&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
				<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;GTS&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;since&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2014&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product&quot;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">&quot;beforeImage&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
				<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TXC&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;since&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2014&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product&quot;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">&quot;sqlType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UPDATE&quot;</span>
	<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;xid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xid:xxx&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>提交前，向 TC 注册分支，申请 <code>product</code> 表中，主键值等于 1 的记录的 <strong>全局锁</strong> 。</li><li>本地事务提交 ，业务数据和 <code>UNDO_LOG</code>一并提交</li><li>将本地事务提交结果上报给 TC</li></ol><h3 id="二阶段" tabindex="-1"><a class="header-anchor" href="#二阶段" aria-hidden="true">#</a> 二阶段</h3><h4 id="提交" tabindex="-1"><a class="header-anchor" href="#提交" aria-hidden="true">#</a> 提交</h4><ol><li>收到 TC 的分支提交请求，把请求放入一个异步任务的队列中，马上返回提交成功的结果给 TC。</li><li>异步任务阶段的分支提交请求将异步和批量地删除相应 UNDO LOG 记录。</li></ol><h4 id="回滚" tabindex="-1"><a class="header-anchor" href="#回滚" aria-hidden="true">#</a> 回滚</h4><ol><li>收到 TC 的分支回滚请求，开启一个本地事务，执行如下操作。</li><li>通过 XID 和 Branch ID 查找到相应的 UNDO LOG 记录。</li><li>数据校验：拿 UNDO LOG 中的后镜与当前数据进行比较，如果有不同，说明数据被当前全局事务之外的动作做了修改。这种情况，需要根据配置策略来做处理，详细的说明在另外的文档中介绍。</li><li>根据 UNDO LOG 中的前镜像和业务 SQL 的相关信息生成并执行回滚的语句：</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">update</span> product <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;TXC&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="5"><li>提交本地事务。并把本地事务的执行结果（即分支事务回滚的结果）上报给 TC。</li></ol><h2 id="coding" tabindex="-1"><a class="header-anchor" href="#coding" aria-hidden="true">#</a> Coding</h2><p>基于 <code>Spring Cloud</code>微服务</p><h3 id="建表" tabindex="-1"><a class="header-anchor" href="#建表" aria-hidden="true">#</a> 建表</h3><p><code>TM</code>和<code>RM</code>业务数据库添加<code>undo_log</code>表</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 注意此处0.7.0+ 增加字段 context</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>context<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rollback_info<span class="token punctuation">`</span></span> <span class="token keyword">longblob</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_created<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ux_undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="依赖" tabindex="-1"><a class="header-anchor" href="#依赖" aria-hidden="true">#</a> 依赖</h3><p>引入 <code>Spring Cloud</code> 和 <code>seata</code> 依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 使用ribbon时才用的上 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- 使用feign时才用的上 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.himcs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加文件" tabindex="-1"><a class="header-anchor" href="#添加文件" aria-hidden="true">#</a> 添加文件</h3><p>项目 <code>resources</code>添加以下两个文件</p><h4 id="registry-conf" tabindex="-1"><a class="header-anchor" href="#registry-conf" aria-hidden="true">#</a> registry.conf</h4><div class="language-conf line-numbers-mode" data-ext="conf"><pre class="language-conf"><code>registry {
  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
  type = &quot;eureka&quot;

  nacos {
    serverAddr = &quot;localhost&quot;
    namespace = &quot;&quot;
    cluster = &quot;default&quot;
  }
  eureka {
    serviceUrl = &quot;http://localhost:8761/eureka&quot;
    application = &quot;default&quot;
    weight = &quot;1&quot;
  }
  redis {
    serverAddr = &quot;localhost:6379&quot;
    db = &quot;0&quot;
    password = &quot;&quot;
    cluster = &quot;default&quot;
    timeout = &quot;0&quot;
  }
  zk {
    cluster = &quot;default&quot;
    serverAddr = &quot;127.0.0.1:2181&quot;
    session.timeout = 6000
    connect.timeout = 2000
    username = &quot;&quot;
    password = &quot;&quot;
  }
  consul {
    cluster = &quot;default&quot;
    serverAddr = &quot;127.0.0.1:8500&quot;
  }
  etcd3 {
    cluster = &quot;default&quot;
    serverAddr = &quot;http://localhost:2379&quot;
  }
  sofa {
    serverAddr = &quot;127.0.0.1:9603&quot;
    application = &quot;default&quot;
    region = &quot;DEFAULT_ZONE&quot;
    datacenter = &quot;DefaultDataCenter&quot;
    cluster = &quot;default&quot;
    group = &quot;SEATA_GROUP&quot;
    addressWaitTime = &quot;3000&quot;
  }
  file {
    name = &quot;file.conf&quot;
  }
}

config {
  # file、nacos 、apollo、zk、consul、etcd3、springCloudConfig
  type = &quot;file&quot;

  nacos {
    serverAddr = &quot;localhost&quot;
    namespace = &quot;&quot;
    group = &quot;SEATA_GROUP&quot;
  }
  consul {
    serverAddr = &quot;127.0.0.1:8500&quot;
  }
  apollo {
    app.id = &quot;seata-server&quot;
    apollo.meta = &quot;http://192.168.1.204:8801&quot;
    namespace = &quot;application&quot;
  }
  zk {
    serverAddr = &quot;127.0.0.1:2181&quot;
    session.timeout = 6000
    connect.timeout = 2000
    username = &quot;&quot;
    password = &quot;&quot;
  }
  etcd3 {
    serverAddr = &quot;http://localhost:2379&quot;
  }
  file {
    name = &quot;file.conf&quot;
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="file-conf" tabindex="-1"><a class="header-anchor" href="#file-conf" aria-hidden="true">#</a> file.conf</h4><div class="language-conf line-numbers-mode" data-ext="conf"><pre class="language-conf"><code>transport {
  # tcp udt unix-domain-socket
  type = &quot;TCP&quot;
  #NIO NATIVE
  server = &quot;NIO&quot;
  #enable heartbeat
  heartbeat = true
  # the client batch send request enable
  enableClientBatchSendRequest = true
  #thread factory for netty
  threadFactory {
    bossThreadPrefix = &quot;NettyBoss&quot;
    workerThreadPrefix = &quot;NettyServerNIOWorker&quot;
    serverExecutorThread-prefix = &quot;NettyServerBizHandler&quot;
    shareBossWorker = false
    clientSelectorThreadPrefix = &quot;NettyClientSelector&quot;
    clientSelectorThreadSize = 1
    clientWorkerThreadPrefix = &quot;NettyClientWorkerThread&quot;
    # netty boss thread size,will not be used for UDT
    bossThreadSize = 1
    #auto default pin or 8
    workerThreadSize = &quot;default&quot;
  }
  shutdown {
    # when destroy server, wait seconds
    wait = 3
  }
  serialization = &quot;seata&quot;
  compressor = &quot;none&quot;
}
service {
 #vgroup-&gt;rgroup
  vgroup_mapping.my_test_tx_group = &quot;default&quot;
  #only support when registry.type=file, please don&#39;t set multiple addresses
  default.grouplist = &quot;127.0.0.1:8091&quot;
  #degrade, current not support
  enableDegrade = false
  #disable seata
  disableGlobalTransaction = false
}

client {
  rm {
    asyncCommitBufferLimit = 10000
    lock {
      retryInterval = 10
      retryTimes = 30
      retryPolicyBranchRollbackOnConflict = true
    }
    reportRetryCount = 5
    tableMetaCheckEnable = false
    reportSuccessEnable = false
  }
  tm {
    commitRetryCount = 5
    rollbackRetryCount = 5
  }
  undo {
    dataValidation = true
    logSerialization = &quot;jackson&quot;
    logTable = &quot;undo_log&quot;
  }
  log {
    exceptionRate = 100
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置" tabindex="-1"><a class="header-anchor" href="#配置" aria-hidden="true">#</a> 配置</h3><p>配置 <code>eureka</code> 和 <code>datasource</code>和<code>seata</code>，其中 <code>tx-service-group</code> 要和<code>file.conf</code>的<code>vgroup_mapping</code>一致</p><h4 id="application-yml" tabindex="-1"><a class="header-anchor" href="#application-yml" aria-hidden="true">#</a> application.yml</h4><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">MYSQL_HOST</span><span class="token punctuation">:</span> himcs.io
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8811</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> business<span class="token punctuation">-</span>service
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>MYSQL_HOST<span class="token punctuation">:</span>localhost<span class="token punctuation">}</span><span class="token punctuation">:</span>3306/seata<span class="token punctuation">-</span>business<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF8&amp;zeroDateTimeBehavior=convertToNull&amp;serverTimezone=Asia/Shanghai</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">alibaba</span><span class="token punctuation">:</span>
      <span class="token key atrule">seata</span><span class="token punctuation">:</span>
        <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> my_test_tx_group <span class="token comment"># 事务分组</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">serviceUrl</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>8761/eureka/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="数据源代理" tabindex="-1"><a class="header-anchor" href="#数据源代理" aria-hidden="true">#</a> 数据源代理</h4><p>配置 <code>Seata</code>数据源代理</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfiguration</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DruidDataSource</span> <span class="token function">druidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Primary</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSourceProxy</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DruidDataSource</span> druidDataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>druidDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="tm-端" tabindex="-1"><a class="header-anchor" href="#tm-端" aria-hidden="true">#</a> TM 端</h3><p>主类添加 SpringCloud 相关依赖</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableJpaRepositories</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BusinessServerApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">BusinessServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加相关<code>FeignClient</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;${services.order-service}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">OrderDTO</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">OrderDTO</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="全局事务" tabindex="-1"><a class="header-anchor" href="#全局事务" aria-hidden="true">#</a> 全局事务</h4><p>在方法上添加 <code> @GlobalTransactional(name = &quot;fsp-sale&quot;, timeoutMills = 20000, rollbackFor = Exception.class)</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BusinessServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">BusinessService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PointsService</span> pointsService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StorageService</span> storageService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 商品销售
     *
     * <span class="token keyword">@param</span> <span class="token parameter">goodsCode</span> 商品编码
     * <span class="token keyword">@param</span> <span class="token parameter">quantity</span>  销售数量
     * <span class="token keyword">@param</span> <span class="token parameter">username</span>  用户名
     * <span class="token keyword">@param</span> <span class="token parameter">points</span>    增加积分
     * <span class="token keyword">@param</span> <span class="token parameter">amount</span>    订单金额
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token comment">// TM 向 TC发起全局事务 生成 XID(全局锁）</span>
<span class="token comment">//</span>
    <span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;fsp-sale&quot;</span><span class="token punctuation">,</span> timeoutMills <span class="token operator">=</span> <span class="token number">20000</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OrderDTO</span> <span class="token function">sale</span><span class="token punctuation">(</span><span class="token class-name">String</span> goodsCode<span class="token punctuation">,</span> <span class="token class-name">Integer</span> quantity<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Integer</span> points<span class="token punctuation">,</span> <span class="token class-name">Integer</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PointsDTO</span> pointsDTO <span class="token operator">=</span> <span class="token class-name">PointsDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">points</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StorageDTO</span> storageDTO <span class="token operator">=</span> <span class="token class-name">StorageDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">goodsCode</span><span class="token punctuation">(</span>goodsCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">quantity</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OrderDTO</span> request <span class="token operator">=</span> <span class="token class-name">OrderDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">points</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">goodsCode</span><span class="token punctuation">(</span>goodsCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">quantity</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">amount</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写表 UNDO_LOG 记录回滚日志（BranchID),通知TC操作结果</span>
        pointsService<span class="token punctuation">.</span><span class="token function">increase</span><span class="token punctuation">(</span>pointsDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写表 UNDO_LOG 记录回滚日志（BranchID),通知TC操作结果</span>
        storageService<span class="token punctuation">.</span><span class="token function">decrease</span><span class="token punctuation">(</span>storageDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写表 UNDO_LOG 记录回滚日志（BranchID),通知TC操作结果</span>
        <span class="token class-name">OrderDTO</span> order <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 分支 a 执行成功 TM 通知 TC 全局提交</span>
        <span class="token comment">// 分支 a TC 通知所有RM 提交成功， 删除 UNDO_LOG 回滚日志</span>

        <span class="token comment">// 分支 b 执行失败 TM 通知 TC 全局 Rollback</span>
        <span class="token comment">// 分支 b TC 通知所有RM 进行回滚， 根据 UNDO_LOG 反向操作 还原数据 删除 UNDO_LOG</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="rm-端" tabindex="-1"><a class="header-anchor" href="#rm-端" aria-hidden="true">#</a> RM 端</h3><p>按照配置依次配置依赖，添加文件，配置代理源即可</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 787632628@qq.com">himcs</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: lik0x01@sp.noahgroup.com">himcs</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/middleware/seata/CAP_basic.html" class="" aria-label="CAP定理"><!--[--><!--]--> CAP定理 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-02526c39.js" defer></script>
  </body>
</html>

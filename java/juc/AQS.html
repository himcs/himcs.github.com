<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.60">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>AQS | mcs site</title><meta name="description" content="mcs site">
    <link rel="preload" href="/assets/style-d36873cb.css" as="style"><link rel="stylesheet" href="/assets/style-d36873cb.css">
    <link rel="modulepreload" href="/assets/app-02526c39.js"><link rel="modulepreload" href="/assets/framework-fa6fd9c7.js"><link rel="modulepreload" href="/assets/AQS.html-781c241f.js"><link rel="modulepreload" href="/assets/AQS.html-1fa75d6e.js"><link rel="prefetch" href="/assets/index.html-e3637351.js" as="script"><link rel="prefetch" href="/assets/BFS.html-5ee798f8.js" as="script"><link rel="prefetch" href="/assets/index.html-b93b8b77.js" as="script"><link rel="prefetch" href="/assets/treeInRDBMS.html-b2b46b19.js" as="script"><link rel="prefetch" href="/assets/二分算法.html-c8df13fd.js" as="script"><link rel="prefetch" href="/assets/排序算法.html-18a21f06.js" as="script"><link rel="prefetch" href="/assets/index.html-44b467fe.js" as="script"><link rel="prefetch" href="/assets/index.html-d6a6781a.js" as="script"><link rel="prefetch" href="/assets/限流算法.html-5d142028.js" as="script"><link rel="prefetch" href="/assets/index.html-55c950d8.js" as="script"><link rel="prefetch" href="/assets/index.html-a32de3d5.js" as="script"><link rel="prefetch" href="/assets/贷款利息公式.html-9dbeddb4.js" as="script"><link rel="prefetch" href="/assets/index.html-36798202.js" as="script"><link rel="prefetch" href="/assets/12factor.html-479c9438.js" as="script"><link rel="prefetch" href="/assets/index.html-d6f2d380.js" as="script"><link rel="prefetch" href="/assets/index.html-7fa4712d.js" as="script"><link rel="prefetch" href="/assets/index.html-72ac39b0.js" as="script"><link rel="prefetch" href="/assets/codegen.html-abfab9e5.js" as="script"><link rel="prefetch" href="/assets/excel_string.html-935fe534.js" as="script"><link rel="prefetch" href="/assets/index.html-0fb3ce0a.js" as="script"><link rel="prefetch" href="/assets/maven配置.html-3e6edaf7.js" as="script"><link rel="prefetch" href="/assets/pdf_better.html-57bb6dee.js" as="script"><link rel="prefetch" href="/assets/pdf_page.html-af326694.js" as="script"><link rel="prefetch" href="/assets/pic_go.html-c25e020c.js" as="script"><link rel="prefetch" href="/assets/soft.html-e9adc608.js" as="script"><link rel="prefetch" href="/assets/util_web.html-1dcdb62e.js" as="script"><link rel="prefetch" href="/assets/MySQL参数配置.html-6266d173.js" as="script"><link rel="prefetch" href="/assets/mysql_group_contact.html-0d64789d.js" as="script"><link rel="prefetch" href="/assets/密码修改.html-84b8ee4d.js" as="script"><link rel="prefetch" href="/assets/事务.html-b84d52f2.js" as="script"><link rel="prefetch" href="/assets/es_base.html-51d680c5.js" as="script"><link rel="prefetch" href="/assets/es_search.html-b277d662.js" as="script"><link rel="prefetch" href="/assets/aggregate.html-5edc4211.js" as="script"><link rel="prefetch" href="/assets/base.html-3e24dec1.js" as="script"><link rel="prefetch" href="/assets/数据库范式.html-ece9fdd9.js" as="script"><link rel="prefetch" href="/assets/BigDecimal.html-a726fc42.js" as="script"><link rel="prefetch" href="/assets/0basic.html-e114fc05.js" as="script"><link rel="prefetch" href="/assets/1ObjectsAndClasses.html-244abc3a.js" as="script"><link rel="prefetch" href="/assets/2Extends.html-3c7595e9.js" as="script"><link rel="prefetch" href="/assets/3Interface.html-91928fde.js" as="script"><link rel="prefetch" href="/assets/Collection.html-7e31158e.js" as="script"><link rel="prefetch" href="/assets/IO.html-7883374d.js" as="script"><link rel="prefetch" href="/assets/NIO.html-165e80b1.js" as="script"><link rel="prefetch" href="/assets/Stream.html-49b7afe6.js" as="script"><link rel="prefetch" href="/assets/generic.html-0c3a1060.js" as="script"><link rel="prefetch" href="/assets/index.html-53823c0b.js" as="script"><link rel="prefetch" href="/assets/正则表达式.html-3824543e.js" as="script"><link rel="prefetch" href="/assets/index.html-dae21037.js" as="script"><link rel="prefetch" href="/assets/JVM内存模型.html-f3a84bf2.js" as="script"><link rel="prefetch" href="/assets/ServiceLoader.html-c3f4cb27.js" as="script"><link rel="prefetch" href="/assets/index.html-8adf4226.js" as="script"><link rel="prefetch" href="/assets/Jar_Manifest_File.html-9f6d982b.js" as="script"><link rel="prefetch" href="/assets/项目自动化.html-b02671c6.js" as="script"><link rel="prefetch" href="/assets/Spring集成测试.html-cea17b5c.js" as="script"><link rel="prefetch" href="/assets/todo_api.html-30a717d8.js" as="script"><link rel="prefetch" href="/assets/todo_cli.html-24da0206.js" as="script"><link rel="prefetch" href="/assets/todo_core.html-d7fa5216.js" as="script"><link rel="prefetch" href="/assets/什么是好的自动化测试.html-625021f6.js" as="script"><link rel="prefetch" href="/assets/如何让测试可控.html-9bd68e1a.js" as="script"><link rel="prefetch" href="/assets/AQS.html-bef6daa9.js" as="script"><link rel="prefetch" href="/assets/BlockingQueue.html-e4caeea2.js" as="script"><link rel="prefetch" href="/assets/Java多线程基础类和接口.html-cce41823.js" as="script"><link rel="prefetch" href="/assets/Java线程状态.html-d35c6bcb.js" as="script"><link rel="prefetch" href="/assets/Java线程通信.html-73a83f83.js" as="script"><link rel="prefetch" href="/assets/Lock接口.html-670d27d5.js" as="script"><link rel="prefetch" href="/assets/cas.html-c8e3a4d1.js" as="script"><link rel="prefetch" href="/assets/synchronized.html-d6115ee8.js" as="script"><link rel="prefetch" href="/assets/volatile.html-d877712a.js" as="script"><link rel="prefetch" href="/assets/内存模型.html-40c19b4b.js" as="script"><link rel="prefetch" href="/assets/线程池.html-4c4a7e17.js" as="script"><link rel="prefetch" href="/assets/线程组和优先级.html-b60a47d4.js" as="script"><link rel="prefetch" href="/assets/重排序.html-b02e11fe.js" as="script"><link rel="prefetch" href="/assets/cron.html-e6d81514.js" as="script"><link rel="prefetch" href="/assets/index.html-503c299a.js" as="script"><link rel="prefetch" href="/assets/lombok.html-6255110e.js" as="script"><link rel="prefetch" href="/assets/mockito.html-d73411a8.js" as="script"><link rel="prefetch" href="/assets/proto-idea.html-5874f2e3.js" as="script"><link rel="prefetch" href="/assets/rabbitmq_start.html-ac480885.js" as="script"><link rel="prefetch" href="/assets/redis.html-de21c0e3.js" as="script"><link rel="prefetch" href="/assets/redis_lock.html-ca6d4e37.js" as="script"><link rel="prefetch" href="/assets/redis_shared.html-fda6e554.js" as="script"><link rel="prefetch" href="/assets/AT.html-9b666f6a.js" as="script"><link rel="prefetch" href="/assets/CAP_basic.html-f19a83be.js" as="script"><link rel="prefetch" href="/assets/TCC.html-94921cc0.js" as="script"><link rel="prefetch" href="/assets/MI8SE.html-b5328645.js" as="script"><link rel="prefetch" href="/assets/docker-expose.html-5082f704.js" as="script"><link rel="prefetch" href="/assets/docker_core.html-412ece21.js" as="script"><link rel="prefetch" href="/assets/jar_develop.html-8579df3c.js" as="script"><link rel="prefetch" href="/assets/linux_config.html-33df38ea.js" as="script"><link rel="prefetch" href="/assets/git_ssh.html-99eadbb9.js" as="script"><link rel="prefetch" href="/assets/travis-with-hexo.html-65a3d5f0.js" as="script"><link rel="prefetch" href="/assets/IDEA_plugin_dev.html-8c3709ae.js" as="script"><link rel="prefetch" href="/assets/awk.html-c7d57f15.js" as="script"><link rel="prefetch" href="/assets/centos_static_IP_config.html-0d27a5d3.js" as="script"><link rel="prefetch" href="/assets/nginx.html-a4ca41a0.js" as="script"><link rel="prefetch" href="/assets/server-move.html-b0670287.js" as="script"><link rel="prefetch" href="/assets/ssh-D.html-4fdcc6c6.js" as="script"><link rel="prefetch" href="/assets/ssr-create.html-8ef39818.js" as="script"><link rel="prefetch" href="/assets/PHP.html-3cf89290.js" as="script"><link rel="prefetch" href="/assets/curlproxy.html-c3a14c51.js" as="script"><link rel="prefetch" href="/assets/ext.html-4de68fd7.js" as="script"><link rel="prefetch" href="/assets/lock.html-28c2dd8a.js" as="script"><link rel="prefetch" href="/assets/nginxconf.html-fbe8ed13.js" as="script"><link rel="prefetch" href="/assets/php_ob.html-2ad368bb.js" as="script"><link rel="prefetch" href="/assets/srv.html-0ea4bbca.js" as="script"><link rel="prefetch" href="/assets/scrapy-env.html-66ff8592.js" as="script"><link rel="prefetch" href="/assets/scrapy_develop.html-5142715c.js" as="script"><link rel="prefetch" href="/assets/scrapy_env.html-902aed7b.js" as="script"><link rel="prefetch" href="/assets/svn-cantup.html-061bfbb0.js" as="script"><link rel="prefetch" href="/assets/svn_auto_update.html-cd3ccf12.js" as="script"><link rel="prefetch" href="/assets/arch.html-f902c8b5.js" as="script"><link rel="prefetch" href="/assets/routing.html-6b299493.js" as="script"><link rel="prefetch" href="/assets/JWT.html-f4039123.js" as="script"><link rel="prefetch" href="/assets/OAuth2.html-903f628a.js" as="script"><link rel="prefetch" href="/assets/SpringBoot-Github.html-59fc45f8.js" as="script"><link rel="prefetch" href="/assets/tcp.html-560a7178.js" as="script"><link rel="prefetch" href="/assets/activiti.html-d71efd9d.js" as="script"><link rel="prefetch" href="/assets/一把梭.html-10e1ccfe.js" as="script"><link rel="prefetch" href="/assets/网关.html-dcd4a9b1.js" as="script"><link rel="prefetch" href="/assets/1_Eureka_register.html-b07da420.js" as="script"><link rel="prefetch" href="/assets/2_Eureka_register.html-4c6debea.js" as="script"><link rel="prefetch" href="/assets/3_Eureka_call.html-626eb68c.js" as="script"><link rel="prefetch" href="/assets/4_Eureka_config_basic.html-7591a700.js" as="script"><link rel="prefetch" href="/assets/4_Eureka_config_basic2.html-feedb7f4.js" as="script"><link rel="prefetch" href="/assets/5_Eureka_Zuul.html-f111e9ea.js" as="script"><link rel="prefetch" href="/assets/6_Eureka_Sleuth_Zipkin.html-f3407eb6.js" as="script"><link rel="prefetch" href="/assets/index.html-b7141cd3.js" as="script"><link rel="prefetch" href="/assets/CAP定理.html-c771abde.js" as="script"><link rel="prefetch" href="/assets/Seata.html-56d00a79.js" as="script"><link rel="prefetch" href="/assets/idea_jsp.html-7ef6297a.js" as="script"><link rel="prefetch" href="/assets/office_act.html-8a66cf24.js" as="script"><link rel="prefetch" href="/assets/B_.html-90eb6756.js" as="script"><link rel="prefetch" href="/assets/索引分类.html-5532e68b.js" as="script"><link rel="prefetch" href="/assets/index.html-5d54cb41.js" as="script"><link rel="prefetch" href="/assets/mbg.html-32085233.js" as="script"><link rel="prefetch" href="/assets/Spring Cloud Gateway.html-d7f21a0b.js" as="script"><link rel="prefetch" href="/assets/nacos deploy.html-edded1db.js" as="script"><link rel="prefetch" href="/assets/创建nacos服务.html-1a7558b9.js" as="script"><link rel="prefetch" href="/assets/OpenFeign.html-a24132b2.js" as="script"><link rel="prefetch" href="/assets/ribbon负载均衡.html-3055b63f.js" as="script"><link rel="prefetch" href="/assets/Sentinel.html-1ce0d153.js" as="script"><link rel="prefetch" href="/assets/Sentinel与Nacos配置持久化.html-44b21a2a.js" as="script"><link rel="prefetch" href="/assets/Sentinel熔断机制.html-24c98ca4.js" as="script"><link rel="prefetch" href="/assets/Sentine流量控制.html-564c80d6.js" as="script"><link rel="prefetch" href="/assets/整合openfeign.html-a3964a2e.js" as="script"><link rel="prefetch" href="/assets/会话一致性解决方案.html-a733f2e1.js" as="script"><link rel="prefetch" href="/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/assets/index.html-e6f8a7c5.js" as="script"><link rel="prefetch" href="/assets/BFS.html-5fb14798.js" as="script"><link rel="prefetch" href="/assets/index.html-b54f06be.js" as="script"><link rel="prefetch" href="/assets/treeInRDBMS.html-6760905c.js" as="script"><link rel="prefetch" href="/assets/二分算法.html-0cbd6296.js" as="script"><link rel="prefetch" href="/assets/排序算法.html-a7730e87.js" as="script"><link rel="prefetch" href="/assets/index.html-d61d59d3.js" as="script"><link rel="prefetch" href="/assets/index.html-19dc7e77.js" as="script"><link rel="prefetch" href="/assets/限流算法.html-2796e57b.js" as="script"><link rel="prefetch" href="/assets/index.html-def37add.js" as="script"><link rel="prefetch" href="/assets/index.html-24ad8b59.js" as="script"><link rel="prefetch" href="/assets/贷款利息公式.html-a4c6ad86.js" as="script"><link rel="prefetch" href="/assets/index.html-b3153526.js" as="script"><link rel="prefetch" href="/assets/12factor.html-fe9f668c.js" as="script"><link rel="prefetch" href="/assets/index.html-02a80aeb.js" as="script"><link rel="prefetch" href="/assets/index.html-12ad56a6.js" as="script"><link rel="prefetch" href="/assets/index.html-1936f5cd.js" as="script"><link rel="prefetch" href="/assets/codegen.html-668ef229.js" as="script"><link rel="prefetch" href="/assets/excel_string.html-6d59f44f.js" as="script"><link rel="prefetch" href="/assets/index.html-f457a55e.js" as="script"><link rel="prefetch" href="/assets/maven配置.html-7af68477.js" as="script"><link rel="prefetch" href="/assets/pdf_better.html-4b67b1fd.js" as="script"><link rel="prefetch" href="/assets/pdf_page.html-71dd14c7.js" as="script"><link rel="prefetch" href="/assets/pic_go.html-03f0fe81.js" as="script"><link rel="prefetch" href="/assets/soft.html-2baea67a.js" as="script"><link rel="prefetch" href="/assets/util_web.html-043e8e7e.js" as="script"><link rel="prefetch" href="/assets/MySQL参数配置.html-fdbdcc9f.js" as="script"><link rel="prefetch" href="/assets/mysql_group_contact.html-52815ae3.js" as="script"><link rel="prefetch" href="/assets/密码修改.html-40b974b5.js" as="script"><link rel="prefetch" href="/assets/事务.html-def9165d.js" as="script"><link rel="prefetch" href="/assets/es_base.html-294cb6cd.js" as="script"><link rel="prefetch" href="/assets/es_search.html-13233a0c.js" as="script"><link rel="prefetch" href="/assets/aggregate.html-4c7705e0.js" as="script"><link rel="prefetch" href="/assets/base.html-cc59d641.js" as="script"><link rel="prefetch" href="/assets/数据库范式.html-a4394ceb.js" as="script"><link rel="prefetch" href="/assets/BigDecimal.html-847102ad.js" as="script"><link rel="prefetch" href="/assets/0basic.html-02259f9c.js" as="script"><link rel="prefetch" href="/assets/1ObjectsAndClasses.html-d2e4af1b.js" as="script"><link rel="prefetch" href="/assets/2Extends.html-02388a15.js" as="script"><link rel="prefetch" href="/assets/3Interface.html-fa289196.js" as="script"><link rel="prefetch" href="/assets/Collection.html-3b94d71b.js" as="script"><link rel="prefetch" href="/assets/IO.html-c6e1c346.js" as="script"><link rel="prefetch" href="/assets/NIO.html-d7cd796e.js" as="script"><link rel="prefetch" href="/assets/Stream.html-436caa95.js" as="script"><link rel="prefetch" href="/assets/generic.html-ebb05c32.js" as="script"><link rel="prefetch" href="/assets/index.html-f2aa8179.js" as="script"><link rel="prefetch" href="/assets/正则表达式.html-d52734ce.js" as="script"><link rel="prefetch" href="/assets/index.html-700e307f.js" as="script"><link rel="prefetch" href="/assets/JVM内存模型.html-0a056841.js" as="script"><link rel="prefetch" href="/assets/ServiceLoader.html-59947863.js" as="script"><link rel="prefetch" href="/assets/index.html-e95ca13d.js" as="script"><link rel="prefetch" href="/assets/Jar_Manifest_File.html-6530dcd4.js" as="script"><link rel="prefetch" href="/assets/项目自动化.html-aa5ec372.js" as="script"><link rel="prefetch" href="/assets/Spring集成测试.html-2316d15b.js" as="script"><link rel="prefetch" href="/assets/todo_api.html-db1e7e85.js" as="script"><link rel="prefetch" href="/assets/todo_cli.html-02eecfb2.js" as="script"><link rel="prefetch" href="/assets/todo_core.html-86b653a7.js" as="script"><link rel="prefetch" href="/assets/什么是好的自动化测试.html-02b0c16d.js" as="script"><link rel="prefetch" href="/assets/如何让测试可控.html-f6754cac.js" as="script"><link rel="prefetch" href="/assets/AQS.html-8bc07cf0.js" as="script"><link rel="prefetch" href="/assets/BlockingQueue.html-8eacee2a.js" as="script"><link rel="prefetch" href="/assets/Java多线程基础类和接口.html-8a4b5dcb.js" as="script"><link rel="prefetch" href="/assets/Java线程状态.html-04c6bb5f.js" as="script"><link rel="prefetch" href="/assets/Java线程通信.html-ee849129.js" as="script"><link rel="prefetch" href="/assets/Lock接口.html-8edf2b85.js" as="script"><link rel="prefetch" href="/assets/cas.html-074f2187.js" as="script"><link rel="prefetch" href="/assets/synchronized.html-80e5e10e.js" as="script"><link rel="prefetch" href="/assets/volatile.html-cd0a377d.js" as="script"><link rel="prefetch" href="/assets/内存模型.html-0bf6b3c2.js" as="script"><link rel="prefetch" href="/assets/线程池.html-e4ba347e.js" as="script"><link rel="prefetch" href="/assets/线程组和优先级.html-07ff6b17.js" as="script"><link rel="prefetch" href="/assets/重排序.html-1df412d2.js" as="script"><link rel="prefetch" href="/assets/cron.html-89cef6ef.js" as="script"><link rel="prefetch" href="/assets/index.html-72df99e1.js" as="script"><link rel="prefetch" href="/assets/lombok.html-2ab71d80.js" as="script"><link rel="prefetch" href="/assets/mockito.html-5e63e9a6.js" as="script"><link rel="prefetch" href="/assets/proto-idea.html-5f8350a7.js" as="script"><link rel="prefetch" href="/assets/rabbitmq_start.html-8d9d7efe.js" as="script"><link rel="prefetch" href="/assets/redis.html-c6346aab.js" as="script"><link rel="prefetch" href="/assets/redis_lock.html-704fb123.js" as="script"><link rel="prefetch" href="/assets/redis_shared.html-329e114a.js" as="script"><link rel="prefetch" href="/assets/AT.html-ea2a2786.js" as="script"><link rel="prefetch" href="/assets/CAP_basic.html-3f0d34f7.js" as="script"><link rel="prefetch" href="/assets/TCC.html-e7ae49db.js" as="script"><link rel="prefetch" href="/assets/MI8SE.html-851d720a.js" as="script"><link rel="prefetch" href="/assets/docker-expose.html-a9532fdc.js" as="script"><link rel="prefetch" href="/assets/docker_core.html-f94a8ba5.js" as="script"><link rel="prefetch" href="/assets/jar_develop.html-cab1dd4a.js" as="script"><link rel="prefetch" href="/assets/linux_config.html-9154d9e1.js" as="script"><link rel="prefetch" href="/assets/git_ssh.html-3df5f353.js" as="script"><link rel="prefetch" href="/assets/travis-with-hexo.html-9cdc54a7.js" as="script"><link rel="prefetch" href="/assets/IDEA_plugin_dev.html-7b31c2ad.js" as="script"><link rel="prefetch" href="/assets/awk.html-0ca75610.js" as="script"><link rel="prefetch" href="/assets/centos_static_IP_config.html-46b38a0d.js" as="script"><link rel="prefetch" href="/assets/nginx.html-5983a503.js" as="script"><link rel="prefetch" href="/assets/server-move.html-93ca44f8.js" as="script"><link rel="prefetch" href="/assets/ssh-D.html-a52211e6.js" as="script"><link rel="prefetch" href="/assets/ssr-create.html-e7ee6604.js" as="script"><link rel="prefetch" href="/assets/PHP.html-f556dadb.js" as="script"><link rel="prefetch" href="/assets/curlproxy.html-c7c1967d.js" as="script"><link rel="prefetch" href="/assets/ext.html-74acd3da.js" as="script"><link rel="prefetch" href="/assets/lock.html-ebfb3abb.js" as="script"><link rel="prefetch" href="/assets/nginxconf.html-edc332f1.js" as="script"><link rel="prefetch" href="/assets/php_ob.html-1882ff45.js" as="script"><link rel="prefetch" href="/assets/srv.html-3249fd1b.js" as="script"><link rel="prefetch" href="/assets/scrapy-env.html-44d856dc.js" as="script"><link rel="prefetch" href="/assets/scrapy_develop.html-355280bc.js" as="script"><link rel="prefetch" href="/assets/scrapy_env.html-b0a15e9c.js" as="script"><link rel="prefetch" href="/assets/svn-cantup.html-f6015702.js" as="script"><link rel="prefetch" href="/assets/svn_auto_update.html-120baa32.js" as="script"><link rel="prefetch" href="/assets/arch.html-d37bceef.js" as="script"><link rel="prefetch" href="/assets/routing.html-5c87e9b8.js" as="script"><link rel="prefetch" href="/assets/JWT.html-a3ae250b.js" as="script"><link rel="prefetch" href="/assets/OAuth2.html-1bd45457.js" as="script"><link rel="prefetch" href="/assets/SpringBoot-Github.html-992b560f.js" as="script"><link rel="prefetch" href="/assets/tcp.html-0706a3f0.js" as="script"><link rel="prefetch" href="/assets/activiti.html-13c8ca61.js" as="script"><link rel="prefetch" href="/assets/一把梭.html-f72f929b.js" as="script"><link rel="prefetch" href="/assets/网关.html-a2161940.js" as="script"><link rel="prefetch" href="/assets/1_Eureka_register.html-f8c331a0.js" as="script"><link rel="prefetch" href="/assets/2_Eureka_register.html-c7a6fac0.js" as="script"><link rel="prefetch" href="/assets/3_Eureka_call.html-ef9eba75.js" as="script"><link rel="prefetch" href="/assets/4_Eureka_config_basic.html-10da1b2b.js" as="script"><link rel="prefetch" href="/assets/4_Eureka_config_basic2.html-8af8b430.js" as="script"><link rel="prefetch" href="/assets/5_Eureka_Zuul.html-d7fdd11d.js" as="script"><link rel="prefetch" href="/assets/6_Eureka_Sleuth_Zipkin.html-06c7bbfd.js" as="script"><link rel="prefetch" href="/assets/index.html-4988c18b.js" as="script"><link rel="prefetch" href="/assets/CAP定理.html-a3e291fd.js" as="script"><link rel="prefetch" href="/assets/Seata.html-a11867d5.js" as="script"><link rel="prefetch" href="/assets/idea_jsp.html-e1c81b49.js" as="script"><link rel="prefetch" href="/assets/office_act.html-a3c6a531.js" as="script"><link rel="prefetch" href="/assets/B_.html-8e022b10.js" as="script"><link rel="prefetch" href="/assets/索引分类.html-1ebd5e92.js" as="script"><link rel="prefetch" href="/assets/index.html-1acbdbf1.js" as="script"><link rel="prefetch" href="/assets/mbg.html-a40aadf3.js" as="script"><link rel="prefetch" href="/assets/Spring Cloud Gateway.html-9f34da7a.js" as="script"><link rel="prefetch" href="/assets/nacos deploy.html-cee59b7d.js" as="script"><link rel="prefetch" href="/assets/创建nacos服务.html-ed0a97c0.js" as="script"><link rel="prefetch" href="/assets/OpenFeign.html-eec9668e.js" as="script"><link rel="prefetch" href="/assets/ribbon负载均衡.html-50b5b10e.js" as="script"><link rel="prefetch" href="/assets/Sentinel.html-d2503809.js" as="script"><link rel="prefetch" href="/assets/Sentinel与Nacos配置持久化.html-b474951f.js" as="script"><link rel="prefetch" href="/assets/Sentinel熔断机制.html-987ad85d.js" as="script"><link rel="prefetch" href="/assets/Sentine流量控制.html-64beff1b.js" as="script"><link rel="prefetch" href="/assets/整合openfeign.html-93d9360b.js" as="script"><link rel="prefetch" href="/assets/会话一致性解决方案.html-298009db.js" as="script"><link rel="prefetch" href="/assets/404.html-065e9e30.js" as="script"><link rel="prefetch" href="/assets/index-70769223.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="https://vuejs.org/images/logo.png" alt="mcs site"><span class="site-name can-hide">mcs site</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/java/" class="router-link-active" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/spring/cloud/" class="" aria-label="Spring Cloud"><!--[--><!--]--> Spring Cloud <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/java/framework/" class="" aria-label="框架"><!--[--><!--]--> 框架 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/ha" class="" aria-label="高可用"><!--[--><!--]--> 高可用 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Data"><span class="title">Data</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Data"><span class="title">Data</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/database/" class="" aria-label="数据库"><!--[--><!--]--> 数据库 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/middleware/" class="" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/alg/" class="" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/rfc/" class="" aria-label="RFC"><!--[--><!--]--> RFC <!--[--><!--]--></a></div><div class="navbar-item"><a href="/util/" class="" aria-label="工具"><!--[--><!--]--> 工具 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/java/" class="router-link-active" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/spring/cloud/" class="" aria-label="Spring Cloud"><!--[--><!--]--> Spring Cloud <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/java/framework/" class="" aria-label="框架"><!--[--><!--]--> 框架 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/ha" class="" aria-label="高可用"><!--[--><!--]--> 高可用 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Data"><span class="title">Data</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Data"><span class="title">Data</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/database/" class="" aria-label="数据库"><!--[--><!--]--> 数据库 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/middleware/" class="" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/alg/" class="" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/rfc/" class="" aria-label="RFC"><!--[--><!--]--> RFC <!--[--><!--]--></a></div><div class="navbar-item"><a href="/util/" class="" aria-label="工具"><!--[--><!--]--> 工具 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">面向对象 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/java/core/0basic.html" class="sidebar-item" aria-label="基本程序结构"><!--[--><!--]--> 基本程序结构 <!--[--><!--]--></a><!----></li><li><a href="/java/core/1ObjectsAndClasses.html" class="sidebar-item" aria-label="Java 对象与类"><!--[--><!--]--> Java 对象与类 <!--[--><!--]--></a><!----></li><li><a href="/java/core/2Extends.html" class="sidebar-item" aria-label="继承 Inheritance"><!--[--><!--]--> 继承 Inheritance <!--[--><!--]--></a><!----></li><li><a href="/java/core/3Interface.html" class="sidebar-item" aria-label="接口和lambda表达式"><!--[--><!--]--> 接口和lambda表达式 <!--[--><!--]--></a><!----></li><li><a href="/java/core/Collection.html" class="sidebar-item" aria-label="集合"><!--[--><!--]--> 集合 <!--[--><!--]--></a><!----></li><li><a href="/java/core/generic.html" class="sidebar-item" aria-label="泛型"><!--[--><!--]--> 泛型 <!--[--><!--]--></a><!----></li><li><a href="/java/core/Stream.html" class="sidebar-item" aria-label="Stream"><!--[--><!--]--> Stream <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">多线程 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/java/thread/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80%E7%B1%BB%E5%92%8C%E6%8E%A5%E5%8F%A3.html" class="sidebar-item" aria-label="Java多线程基础类和接口"><!--[--><!--]--> Java多线程基础类和接口 <!--[--><!--]--></a><!----></li><li><a href="/java/thread/%E7%BA%BF%E7%A8%8B%E7%BB%84%E5%92%8C%E4%BC%98%E5%85%88%E7%BA%A7.html" class="sidebar-item" aria-label="线程组和优先级"><!--[--><!--]--> 线程组和优先级 <!--[--><!--]--></a><!----></li><li><a href="/java/thread/Java%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81.html" class="sidebar-item" aria-label="Java线程状态"><!--[--><!--]--> Java线程状态 <!--[--><!--]--></a><!----></li><li><a href="/java/thread/Java%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1.html" class="sidebar-item" aria-label="Java 线程通信"><!--[--><!--]--> Java 线程通信 <!--[--><!--]--></a><!----></li><li><a href="/java/thread/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html" class="sidebar-item" aria-label="Java 内存模型"><!--[--><!--]--> Java 内存模型 <!--[--><!--]--></a><!----></li><li><a href="/java/thread/%E9%87%8D%E6%8E%92%E5%BA%8F.html" class="sidebar-item" aria-label="重排序"><!--[--><!--]--> 重排序 <!--[--><!--]--></a><!----></li><li><a href="/java/thread/volatile.html" class="sidebar-item" aria-label="volatile"><!--[--><!--]--> volatile <!--[--><!--]--></a><!----></li><li><a href="/java/thread/synchronized.html" class="sidebar-item" aria-label="synchronized与锁"><!--[--><!--]--> synchronized与锁 <!--[--><!--]--></a><!----></li><li><a href="/java/thread/cas.html" class="sidebar-item" aria-label="CAS"><!--[--><!--]--> CAS <!--[--><!--]--></a><!----></li><li><a href="/java/thread/AQS.html" class="sidebar-item" aria-label="AQS"><!--[--><!--]--> AQS <!--[--><!--]--></a><!----></li><li><a href="/java/thread/%E7%BA%BF%E7%A8%8B%E6%B1%A0.html" class="sidebar-item" aria-label="线程池"><!--[--><!--]--> 线程池 <!--[--><!--]--></a><!----></li><li><a href="/java/thread/BlockingQueue.html" class="sidebar-item" aria-label="BlockingQueue"><!--[--><!--]--> BlockingQueue <!--[--><!--]--></a><!----></li><li><a href="/java/thread/Lock%E6%8E%A5%E5%8F%A3.html" class="sidebar-item" aria-label="Lock 接口和类"><!--[--><!--]--> Lock 接口和类 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">JVM <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/java/jvm/JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html" class="sidebar-item" aria-label="JVM 内存模型"><!--[--><!--]--> JVM 内存模型 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">IO <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/java/core/IO.html" class="sidebar-item" aria-label="IO"><!--[--><!--]--> IO <!--[--><!--]--></a><!----></li><li><a href="/java/core/NIO.html" class="sidebar-item" aria-label="NIO"><!--[--><!--]--> NIO <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">实用类 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/java/class/BigDecimal.html" class="sidebar-item" aria-label="BigDecimal"><!--[--><!--]--> BigDecimal <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">Magic <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/java/magic/ServiceLoader.html" class="sidebar-item" aria-label="ServiceLoader"><!--[--><!--]--> ServiceLoader <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">工程化 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/java/project/%E9%A1%B9%E7%9B%AE%E8%87%AA%E5%8A%A8%E5%8C%96.html" class="sidebar-item" aria-label="项目自动化"><!--[--><!--]--> 项目自动化 <!--[--><!--]--></a><!----></li><li><a href="/java/project/Jar_Manifest_File.html" class="sidebar-item" aria-label="Jar Manifest File"><!--[--><!--]--> Jar Manifest File <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">测试课 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/java/test/todo_core.html" class="sidebar-item" aria-label="实现todo应用 内核"><!--[--><!--]--> 实现todo应用 内核 <!--[--><!--]--></a><!----></li><li><a href="/java/test/todo_cli.html" class="sidebar-item" aria-label="实现todo应用CLI"><!--[--><!--]--> 实现todo应用CLI <!--[--><!--]--></a><!----></li><li><a href="/java/test/todo_api.html" class="sidebar-item" aria-label="todo-api"><!--[--><!--]--> todo-api <!--[--><!--]--></a><!----></li><li><a href="/java/test/%E4%BB%80%E4%B9%88%E6%98%AF%E5%A5%BD%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95.html" class="sidebar-item" aria-label="什么是好的自动化测试？"><!--[--><!--]--> 什么是好的自动化测试？ <!--[--><!--]--></a><!----></li><li><a href="/java/test/%E5%A6%82%E4%BD%95%E8%AE%A9%E6%B5%8B%E8%AF%95%E5%8F%AF%E6%8E%A7.html" class="sidebar-item" aria-label="Mock让测试可控"><!--[--><!--]--> Mock让测试可控 <!--[--><!--]--></a><!----></li><li><a href="/java/test/Spring%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95.html" class="sidebar-item" aria-label="Spring 集成测试"><!--[--><!--]--> Spring 集成测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="aqs" tabindex="-1"><a class="header-anchor" href="#aqs" aria-hidden="true">#</a> AQS</h1><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><p>AQS 是 <code>AbstractQueuedSynchronizer</code> 的简称。</p><p>字面意思:</p><ul><li>Abstract: 提供抽象逻辑，子类具体实现</li><li>Queued: 使用FIFO队列存储数据</li><li>Synchronizer: 提供同步功能</li></ul><p>AQS 是用来构建锁和同步器的框架，常用的 <code>ReentrantLock</code>,<code>FutureTask</code>,<code>CountDownLatch</code>都是基于AQS实现的。</p><h2 id="设计" tabindex="-1"><a class="header-anchor" href="#设计" aria-hidden="true">#</a> 设计</h2><p>独占模式:</p><ol><li><code>state = 0</code>，表示被获取资源数量</li><li>线程获取资源前检查 <code>state</code>状态，原子修改<code>state</code>成功，表示资源获取成功，否则加入到等待队列</li><li>占有资源的线程释放资源，原子修改<code>state</code>的值，从队列唤醒阻塞线程，阻塞的线程进行第2步操作</li></ol><h2 id="数据结构" tabindex="-1"><a class="header-anchor" href="#数据结构" aria-hidden="true">#</a> 数据结构</h2><h3 id="state" tabindex="-1"><a class="header-anchor" href="#state" aria-hidden="true">#</a> state</h3><p>state 表示当前同步状态,资源是否可被获取。</p><p><code>private volatile int state;</code></p><p>子类只能通过原子方法变更 state 的值。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>getState()
setState()
compareAndSetState()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="clh-队列" tabindex="-1"><a class="header-anchor" href="#clh-队列" aria-hidden="true">#</a> CLH 队列</h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>     +------+  prev +-----+       +-----+
head |      | &lt;---- |     | &lt;---- |     |  tail
     +------+       +-----+       +-----+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Node 数据结构</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>static final class Node {
    // 标记一个结点（对应的线程）在共享模式下等待
    static final Node SHARED = new Node();
    // 标记一个结点（对应的线程）在独占模式下等待
    static final Node EXCLUSIVE = null; 

    // waitStatus的值，表示该结点（对应的线程）已被取消
    static final int CANCELLED = 1; 
    // waitStatus的值，表示后继结点（对应的线程）需要被唤醒
    static final int SIGNAL = -1;
    // waitStatus的值，表示该结点（对应的线程）在等待某一条件
    static final int CONDITION = -2;
    /*waitStatus的值，表示有资源可用，新head结点需要继续唤醒后继结点（共享模式下，多线程并发释放资源，而head唤醒其后继结点后，需要把多出来的资源留给后面的结点；设置新的head结点时，会继续唤醒其后继结点）*/
    static final int PROPAGATE = -3;

    // 等待状态，取值范围，-3，-2，-1，0，1
    volatile int waitStatus;
    volatile Node prev; // 前驱结点
    volatile Node next; // 后继结点
    volatile Thread thread; // 结点对应的线程
    Node nextWaiter; // 等待队列里下一个等待条件的结点


    // 判断共享模式的方法
    final boolean isShared() {
        return nextWaiter == SHARED;
    }

    Node(Thread thread, Node mode) {     // Used by addWaiter
        this.nextWaiter = mode;
        this.thread = thread;
    }

    // 其它方法忽略，可以参考具体的源码
}

// AQS里面的addWaiter私有方法
private Node addWaiter(Node mode) {
    // 使用了Node的这个构造函数
    Node node = new Node(Thread.currentThread(), mode);
    // 其它代码省略
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="抽象方法" tabindex="-1"><a class="header-anchor" href="#抽象方法" aria-hidden="true">#</a> 抽象方法</h2><p>AQS 设计基于 模板方法模式 。以下方法要子类实现</p><ul><li>isHeldExclusively(): 该线程是否独占资源 只有用到condition才需要去实现它</li><li>tryAcquire(int) : 独占方式。尝试获取资源，成功则返回true，失败则返回false。</li><li>tryRelease(int)：独占方式。尝试释放资源，成功则返回true，失败则返回false。</li><li>tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。</li><li>tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false。</li></ul><h2 id="独占模式" tabindex="-1"><a class="header-anchor" href="#独占模式" aria-hidden="true">#</a> 独占模式</h2><h3 id="获取资源-acquire" tabindex="-1"><a class="header-anchor" href="#获取资源-acquire" aria-hidden="true">#</a> 获取资源 acquire</h3><h4 id="acquire" tabindex="-1"><a class="header-anchor" href="#acquire" aria-hidden="true">#</a> acquire</h4><p>入口方法 acquire(int)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先通过 <code>tryAcquire(arg)</code> 获取资源，由子类实现。</p><p>如果失败，调用 <code>addWaiter(Node.EXCLUSIVE)</code> 将当前线程以独占模式加入到等待队列</p><h4 id="addwaiter" tabindex="-1"><a class="header-anchor" href="#addwaiter" aria-hidden="true">#</a> addWaiter</h4><p><code>addWaiter</code> 具体实现如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//mode 为独占或共享 模式</span>
	<span class="token comment">//生成 当前线程节点</span>
	<span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Try the fast path of enq; backup to full enq on failure</span>
	<span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>
		<span class="token comment">//使用CAS尝试，如果成功就返回</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
			<span class="token keyword">return</span> node<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//如果等待队列为空或者上述CAS失败，再自旋CAS插入</span>
	<span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 自旋CAS插入等待队列</span>
<span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Must initialize</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                tail <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">return</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>addWaiter 将当前线程生成Node，并加入到队列尾部，通过 CAS 自旋保证了线程安全。</p></blockquote><p>添加完节点后，<code>acquireQueued()</code> 使线程在等待队列中获取资源，一直获取到资源后才返回。</p><h4 id="acquirequeued" tabindex="-1"><a class="header-anchor" href="#acquirequeued" aria-hidden="true">#</a> acquireQueued</h4><p>队列的线程自旋且不可中断的方式获取同步状态。直到获取到资源才返回</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果node的前驱结点p是head，表示node是第二个结点，就可以尝试去获取资源了</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 拿到资源后，将head指向该结点。</span>
                <span class="token comment">// 所以head所指的结点，就是当前获取到资源的那个结点或null。</span>
				<span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
				p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
				failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// 如果自己可以休息了，就进入waiting状态，直到被unpark()</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
				<span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
			<span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>parkAndCheckInterrupt 内部使用到了LockSupport.park(this)</p><p>LockSupport 是JDK6引入的类，提供了线程同步原语。</p><p>LockSupport实际上是调用了Unsafe类里的函数，归结到Unsafe里，只有两个函数：</p><ul><li>park(boolean isAbsolute, long time)：阻塞当前线程</li><li>unpark(Thread jthread)：使给定的线程停止阻塞</li></ul></blockquote><p>所以节点进入等待队列后，调用 <code>park</code>进入阻塞状态。只有头节点线程是活跃的。</p><h4 id="shouldparkafterfailedacquire" tabindex="-1"><a class="header-anchor" href="#shouldparkafterfailedacquire" aria-hidden="true">#</a> shouldParkAfterFailedAcquire</h4><p><code>shouldParkAfterFailedAcquire</code>对当前节点的前一个节点的状态进行判断，对当前节点做出不同的操作。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> 
<span class="token doc-comment comment">/**
* 判断是否可以挂起当前线程
*/</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> pred<span class="token punctuation">,</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ws为node前置节点的状态</span>
        <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span>
　　　　　　　<span class="token comment">//如果前置节点状态为SIGNAL，当前节点可以挂起</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             
            <span class="token comment">//通过循环跳过所有的CANCELLED节点，找到一个正常的节点，将当前节点排在它后面</span>

           <span class="token comment">//GC会将这些CANCELLED节点回收</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//将前置节点的状态修改为SIGNAL</span>
            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>线程挂起后，等待<code>unpark()</code>或<code>interrupt()</code>唤醒自己；</p><h4 id="parkandcheckinterrupt" tabindex="-1"><a class="header-anchor" href="#parkandcheckinterrupt" aria-hidden="true">#</a> parkAndCheckInterrupt</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//该函数调用了unsafe.park函数阻塞</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="资源释放-release" tabindex="-1"><a class="header-anchor" href="#资源释放-release" aria-hidden="true">#</a> 资源释放 release</h3><h4 id="release" tabindex="-1"><a class="header-anchor" href="#release" aria-hidden="true">#</a> release</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="unparksuccessor" tabindex="-1"><a class="header-anchor" href="#unparksuccessor" aria-hidden="true">#</a> unparkSuccessor</h4><p>唤醒等待队列中下一个可唤醒线程</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 如果状态是负数，尝试把它设置为0</span>
        <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// 如果这个后继结点为空或者状态大于0</span>
    <span class="token comment">// 通过前面的定义我们知道，大于0只有一种可能，就是这个结点已被取消</span>
        <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// 等待队列中所有还有用的结点，都向前移动</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> node<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    s <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    	<span class="token comment">// 唤醒线程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="共享模式" tabindex="-1"><a class="header-anchor" href="#共享模式" aria-hidden="true">#</a> 共享模式</h2><p>资源不是唯一的，可被多个线程获取，忽略中断。</p><p>AQS 保证严格按照入队顺序唤醒。</p><p>例如 二号节点 需要大量资源（例如全量资源），后面的需要较少资源，二号节点会卡住后面的节点。</p><h3 id="获取共享资源-acquireshared" tabindex="-1"><a class="header-anchor" href="#获取共享资源-acquireshared" aria-hidden="true">#</a> 获取共享资源 acquireShared</h3><p>尝试获取指定数量资源，获取成功返回，失败进入等待队列。</p><p>与独占模式不同的是，当还有剩余资源的时候，会尝试唤醒后续节点。</p><h4 id="acquireshared" tabindex="-1"><a class="header-anchor" href="#acquireshared" aria-hidden="true">#</a> acquireShared</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">doAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="doacquireshared" tabindex="-1"><a class="header-anchor" href="#doacquireshared" aria-hidden="true">#</a> doAcquireShared</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SHARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                         <span class="token comment">//设置新的头结点，并且可能会继续唤醒后继的节点</span>
                        <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>
                            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//寻找合适位置 进入 waiting 状态</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="释放共享资源" tabindex="-1"><a class="header-anchor" href="#释放共享资源" aria-hidden="true">#</a> 释放共享资源</h3><h4 id="releaseshared" tabindex="-1"><a class="header-anchor" href="#releaseshared" aria-hidden="true">#</a> releaseShared</h4><p>释放指定数量资源，并唤醒等待线程。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryReleaseShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="doreleaseshared" tabindex="-1"><a class="header-anchor" href="#doreleaseshared" aria-hidden="true">#</a> doReleaseShared</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> ws <span class="token operator">=</span> h<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token comment">// loop to recheck cases</span>
                    <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                         <span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">PROPAGATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token comment">// loop on failed CAS</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> head<span class="token punctuation">)</span>                   <span class="token comment">// loop if head changed</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2><p>https://redspider.gitbook.io/concurrent/di-er-pian-yuan-li-pian/11#11.1-aqs-jian-jie</p><p>https://www.jianshu.com/p/da9d051dcc3d</p><p>https://juejin.cn/post/6844903583234654221#heading-0</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: mcshimcs@gmail.com">mcs</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-02526c39.js" defer></script>
  </body>
</html>
